Protocol Four:

Declarations:
    aenc/2;
    senc/2;
    g/0;

Types:
    Agent A,B;
    Number x,y,N1,N2;
    Function g;
    Mapping pk, sk, K;

Knowledge:
    A : pk(A), sk(A), pk(B);
    B : pk(B), sk(B), pk(A);

Public:
    pk(A), pk(B);

Private:
    sk(A), sk(B);

Actions:
    [m1] A -> B (x, N1) : aenc{ A . g()^x . N1 } sk(A);
    [m2] B -> A (y, N2) : aenc{ B . g()^y . senc{ N1 } K(A,B) . N2 } sk(B);
    [m3] A -> B         : senc{ N2 } K(A,B);

Goals:
    /* A authenticates to B via m1 (B verifies signature with pk(A)) */
    A -> B : A . g()^x . N1;
    /* B authenticates to A via m2 (A verifies signature with pk(B)) */
    B -> A : B . g()^y . senc{ N1 } K(A,B) . N2;
    /* Secrecy of session key K(A,B) */
    K(A,B) secret between A,B;

ChannelKeys:
    K(A,B): g()^(x*y);

end