Protocol Four:

Declarations:
    g/0;
    exp/2;
    senc/2;
    kdf/1;

Types:
    Agent A,B;
    Number x, y, NA, NB;
    Symmetric_key KAB;
    Function kdf;
    Mapping pk

Knowledge:
    A : A, B, pk(A), pk(B);
    B : A, B, pk(A), pk(B);

Public:
    g(), pk(A), pk(B);

Private:

Actions:
    [step1] A -> B (x, NA) : exp(g(),x) . NA . A . B;
    [step2] B -> A (y, NB) : exp(g(),y) . senc{ NA }kdf( exp( exp(g(),x) , y ) ) . NB;
    [step3] A -> B       : senc{ NB }kdf( exp( exp(g(),x) , y ) );

Goals:
    B -> A : kdf( exp( exp(g(),x) , y ) );
    A -> B : kdf( exp( exp(g(),x) , y ) );
    kdf( exp( exp(g(),x) , y ) ) secret between A,B;

ChannelKeys:
    K(A,B): kdf( exp( exp(g(),x) , y ) );
    K(B,A): kdf( exp( exp(g(),x) , y ) );

end